"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.BPP=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_dns=_interopRequireDefault(require("dns")),_bsv=_interopRequireDefault(require("bsv")),_paymailClient=require("@moneybutton/paymail-client"),_icellanShapeshifter=_interopRequireDefault(require("icellan-shapeshifter.js"));require("node-fetch");var _temp,BPP=(_temp=function(){function a(){(0,_classCallCheck2["default"])(this,a),this.getPaymailOutput=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=new _paymailClient.PaymailClient(_dns["default"],fetch),a.next=3,d.getOutputFor(b,{senderHandle:"blockpost@moneybutton.com",amount:c,dt:JSON.stringify(new Date)});case 3:return e=a.sent,a.abrupt("return",e.output);case 5:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),this.isTransactionValidPaywallPayment=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e,f,g,h,i,j;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=_icellanShapeshifter["default"].toBob(c),e=d.tx.h,f=b.paywallCurrency,g=b.paywallPayouts,h=1,"BSV"===f){a.next=8;break}return a.next=7,this.getExchangeRate(f);case 7:h=a.sent;case 8:return i=this.getOutputsFromBob(d),j=this.getOutputsFromString(g,h),a.abrupt("return",{txId:e,valid:this.compareOutputs(j,i)});case 11:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),this.errors=[]}return(0,_createClass2["default"])(a,[{key:"getOutputsFromString",value:function getOutputsFromString(a){for(var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,c=a.split(","),d=[],e=0;e<c.length;e++){var f=c[e].split(":"),g=(0,_slicedToArray2["default"])(f,2),h=g[0],j=g[1];d.push({address:h,amount:+j/b})}return d}},{key:"getOutputsFromBob",value:function getOutputsFromBob(b){for(var c=[],d=0;d<b.out.length;d++){var e=b.out[d].e,f=e.v,g=e.a;f&&g&&c.push({address:g,amount:f})}return c}},{key:"getPaymentOutputs",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e,f,g,h,j,k,l,m;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=b.paywallCurrency,d=b.paywallPayouts,e=1,"BSV"===c){a.next=6;break}return a.next=5,this.getExchangeRate(c);case 5:e=a.sent;case 6:for(f=this.getOutputsFromString(d,e),g=[],h=0;h<f.length;h++)j=f[h],k=j.address,l=j.amount,k.match(/@/)?g.push(this.getPaymailOutput(k,l)):(m=new _bsv["default"].Transaction,m.addOutput(new _bsv["default"].Transaction.Output({script:_bsv["default"].Script.buildPublicKeyHashOut(k).toHex(),satoshis:l})),g.push(m.toString("hex")));return a.abrupt("return",g);case 10:case"end":return a.stop();}},a,this)}));return function getPaymentOutputs(){return a.apply(this,arguments)}}()},{key:"getPaymentOutput",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.getPaymentOutputs(b);case 2:for(c=a.sent,d=new _bsv["default"].Transaction,e=0;e<c.length;e++)d.fromBuffer(Buffer.from(c[e],"hex"));return a.abrupt("return",d.toString("hex"));case 6:case"end":return a.stop();}},a,this)}));return function getPaymentOutput(){return a.apply(this,arguments)}}()},{key:"getExchangeRate",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b,c;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,fetch("https://api.whatsonchain.com/v1/bsv/main/exchangerate");case 2:return b=a.sent,a.next=5,b.json();case 5:return c=a.sent,a.abrupt("return",c.rate/1e8);case 7:case"end":return a.stop();}},a)}));return function getExchangeRate(){return a.apply(this,arguments)}}()},{key:"compareOutputs",value:function compareOutputs(a,b){for(var c=this,d=!0,e=function(e){var f=Math.max,g=Math.abs,h=a[e],i=h.address,j=h.amount,k=b.find(function(a){return a.address===i});if(k){var l=g(j-k.amount),m=f(j,k.amount);.1<l/m&&(c.errors.push({address:i,amount:j,output:k,message:"Difference is greater than 10%"}),d=!1)}else c.errors.push({address:i,amount:j,message:"No output found for payment"}),d=!1},f=0;f<a.length;f++)e(f);return d}}]),a}(),_temp);exports.BPP=BPP;